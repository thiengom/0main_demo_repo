const cds = require('../../cds')
const { getPageSize } = require('../utils/page')

const commonGenericPaging = function (req) {
  // only if http request
  if (!req.http?.req) return

  // target === null if view with parameters
  if (!req.target || !req.query?.SELECT || req.query.SELECT.one) return

  _addPaging(req.query, req.target)
}

const _addPaging = function ({ SELECT }, target) {
  const { rows } = SELECT.limit || (SELECT.limit = {})
  const conf = getPageSize(target)
  SELECT.limit.rows = {
    val: !rows ? conf.default : Math.min(rows.val ?? rows, conf.max)
  }
  //Handle nested limits
  if (SELECT.from.SELECT?.limit) _addPaging(SELECT.from, target)
}

/**
 * handler registration
 */
module.exports = cds.service.impl(function () {
  commonGenericPaging._initial = true
  this.before('READ', '*', commonGenericPaging)
})
