const cds = require('../build/cds')
const { _oldMtx } = cds.utils

const _is_streamlined_mtx = ()=>{
  if (_oldMtx()) return false
  try { return !!require.resolve('@sap/cds-mtxs/srv/deployment-service') }
  catch {/* ignored */}
}

if (!cds.requires.multitenancy || _is_streamlined_mtx()) module.exports = undefined
else try {
  // eslint-disable-next-line cds/no-missing-dependencies
  const mtx = module.exports = require ('@sap/cds-mtx')()
  mtx.inject (cds)
  cds.on('served', () => cds.emit('mtx'))
} catch(e) {
  if (e.code === 'MODULE_NOT_FOUND') throw new Error('Error serving MTX APIs: @sap/cds-mtx is not installed')
  else throw e
}

/*
 cds.requires.multitenancy  --  use this to check whether mt is enabled (old or new)
 cds.mtx                    --  use this to check whether old(!) mtx is enabled
*/
